name: Build and Push Docker Image to Docker Hub

on:
  push:
    branches: [ "main" ]

jobs:
  push_to_registry:
   name: Push Docker image to Docker Hub
   runs-on: ubuntu-latest
   steps:
    - name: Check out the repo
      uses: actions/checkout@v3
    
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with: 
        username: ${{ secrets.DH_USERNAME }}
        password: ${{ secrets.DH_PASSWORD }}
        
    - name: Extract metadata (tags, labels) for Docker
      id: meta
      uses: docker/metadata-action@v2
      with: 
        images: my-docker-hub-namespace/my-docker-hub-repository
        
    - name: Build and Push Docker image
      uses: docker/build-push-action@v4
      with: 
        context: .
        push: true
        tags: yarxslav/lab4-cicd-example:latest

  terraform:
   name: 'Terraform'
   runs-on: ubuntu-latest
   steps:
    - name: Checkout
	uses: actions/checkout@v3

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

    - name: Terraform Format
  	id: fmt
  	run: terraform fmt -check

    - name: Terraform Init
  	id: init
      run: terraform init

    - name: Terraform Validate
 	id: validate
  	run: terraform validate -no-color

    - name: Terraform Plan
  	id: plan
  	run: terraform plan -no-color -input=false
  	continue-on-error: true

    - name: Terraform Plan Status
  	if: steps.plan.outcome == 'failure'
  	run: exit 1

    - name: Terraform Apply
  	run: terraform apply -auto-approve -input=false
